{% extends "base.html" %}

{% block title %}Update Data HRIS{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Update Data HRIS</h1>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Manual Procedure Execution -->
    <div class="card">
        <div class="card-header">
            Update Data HRIS
        </div>
        <div class="card-body">
            <p class="card-text">Pilih rentang tanggal yang ingin diperbarui datanya di HRIS.</p>
            <p class="card-text">Pastikan format tanggal sesuai dan data sudah benar sebelum menjalankan proses.</p>
            
            <!-- Job Queue Form (Default) -->
            <div id="jobQueueForm">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    <strong>Rekomendasi:</strong> Menggunakan Job Queue akan memproses data di background tanpa loading.
                </div>
                <form id="workerJobForm">
                    <div class="row g-3 align-items-end">
                        <div class="col-md">
                            <label for="job_start_date" class="form-label">Tanggal Mulai</label>
                            <input type="date" class="form-control" id="job_start_date" name="start_date" required>
                        </div>
                        <div class="col-md">
                            <label for="job_end_date" class="form-label">Tanggal Akhir</label>
                            <input type="date" class="form-control" id="job_end_date" name="end_date" required>
                        </div>
                        <div class="col-md-auto">
                            <button type="submit" class="btn btn-success" id="jobQueueBtn">
                                <i class="fas fa-clock"></i> Proses via Job Queue
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Traditional Form (Hidden by default) -->
            <div id="traditionalForm" style="display: none;">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>Perhatian:</strong> Proses langsung akan menyebabkan halaman loading. Gunakan hanya jika Job Queue bermasalah.
                </div>
                <form action="{{ url_for('worker.run_procedures_manual') }}" method="POST">
                    <div class="row g-3 align-items-end">
                        <div class="col-md">
                            <label for="start_date" class="form-label">Tanggal Mulai</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" required>
                        </div>
                        <div class="col-md">
                            <label for="end_date" class="form-label">Tanggal Akhir</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" required>
                        </div>
                        <div class="col-md-auto">
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-exclamation-triangle"></i> Proses Langsung
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Toggle Button -->
            <div class="mt-3">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleProcessingMethod()">
                    <i class="fas fa-exchange-alt"></i> <span id="toggleText">Gunakan Proses Langsung</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="successModalLabel">
                    <i class="fas fa-check-circle"></i> Jobs Created Successfully
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="successModalContent">
                    <!-- Success content will be filled by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
let isJobQueueMode = true;

function toggleProcessingMethod() {
    const jobQueueForm = document.getElementById('jobQueueForm');
    const traditionalForm = document.getElementById('traditionalForm');
    const toggleText = document.getElementById('toggleText');
    
    if (isJobQueueMode) {
        // Switch to traditional mode
        jobQueueForm.style.display = 'none';
        traditionalForm.style.display = 'block';
        toggleText.textContent = 'Gunakan Job Queue';
        isJobQueueMode = false;
    } else {
        // Switch to job queue mode
        jobQueueForm.style.display = 'block';
        traditionalForm.style.display = 'none';
        toggleText.textContent = 'Gunakan Proses Langsung';
        isJobQueueMode = true;
    }
}

// Handle job queue form submission
document.getElementById('workerJobForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('jobQueueBtn');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Jobs...';
    
    try {
        const formData = new FormData(this);
        const data = {
            start_date: formData.get('start_date'),
            end_date: formData.get('end_date')
        };
        
        const response = await fetch('/worker/run-manual-ajax', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show success modal
            showSuccessModal(result);
            
            // Reset form
            this.reset();
        } else {
            // Show error alert
            showAlert('danger', 'Error: ' + result.message);
        }
        
    } catch (error) {
        console.error('Error:', error);
        showAlert('danger', 'An unexpected error occurred while creating jobs.');
    } finally {
        // Restore button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
});

function showSuccessModal(result) {
    const modalContent = document.getElementById('successModalContent');
    
    let jobsList = '';
    if (result.jobs_created && result.jobs_created.length > 0) {
        jobsList = '<ul class="list-group list-group-flush mt-2">';
        result.jobs_created.forEach(job => {
            jobsList += `<li class="list-group-item d-flex justify-content-between align-items-center">
                <span>Job for ${job.date}</span>
                <small class="text-muted">${job.job_id}</small>
            </li>`;
        });
        jobsList += '</ul>';
    }
    
    modalContent.innerHTML = `
        <div class="alert alert-success mb-0">
            <h6><i class="fas fa-check-circle"></i> ${result.message}</h6>
            <p class="mb-2">Date range: <strong>${result.date_range}</strong></p>
            <p class="mb-0">Total jobs created: <strong>${result.jobs_created.length}</strong></p>
        </div>
        ${jobsList}
        <div class="mt-3">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i> 
                Jobs will be processed in background.
            </small>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('successModal'));
    modal.show();
}

function showAlert(type, message) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    // Insert alert at the top of the container
    const container = document.querySelector('.container');
    const firstChild = container.firstElementChild;
    firstChild.insertAdjacentHTML('afterend', alertHtml);
}

// Set default dates
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('job_start_date').value = today;
    document.getElementById('job_end_date').value = today;
    document.getElementById('start_date').value = today;
    document.getElementById('end_date').value = today;
});
</script>
{% endblock %}
