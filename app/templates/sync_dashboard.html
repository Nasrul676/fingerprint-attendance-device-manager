{% extends "base.html" %}

{% block title %}Sync Dashboard - Attendance System{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Device Synchronization</h1>
        <div>
            <button class="btn btn-success me-2" id="streamingBtn" onclick="toggleStreaming()">
                <i class="fas fa-play"></i> <span id="streamingBtnText">Start Streaming</span>
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#syncAllModal">
                <i class="fas fa-sync-alt"></i> Sync All Devices
            </button>
            <button class="btn btn-outline-secondary" onclick="refreshStatus()">
                <i class="fas fa-refresh"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Streaming Status Alert -->
    <div class="alert alert-info" role="alert" id="streamingStatus" style="display: none;">
        <i class="fas fa-broadcast-tower"></i> 
        <strong>Streaming Status:</strong> <span id="streamingStatusText">Stopped</span>
        <div class="mt-2">
            <small id="streamingDetails">Click "Start Streaming" to begin real-time data capture from devices.</small>
        </div>
    </div>

    <!-- Error Display -->
    {% if error %}
    <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle"></i> {{ error }}
    </div>
    {% endif %}

    <!-- Device Status Cards -->
    <div class="row mb-4">
        {% for device in devices %}
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card device-card" data-device="{{ device.name }}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">Device {{ device.name }} ({{ device.description }})</h6>
                    </div>
                    <span class="badge status-badge badge-{{ device.status }}">
                        {{ device.status.title() }}
                    </span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <small class="text-muted">IP Address</small>
                            <div>{{ device.ip }}:{{ device.port }}</div>
                        </div>
                    </div>
                    {% if device.location %}
                    <div class="row mt-2">
                        <div class="col">
                            <small class="text-muted">Location</small>
                            <div>
                                <i class="fas fa-map-marker-alt text-muted me-1"></i>{{ device.location }}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <div class="row mt-2">
                        <div class="col">
                            <small class="text-muted">Status</small>
                            <div class="status-message">{{ device.message }}</div>
                        </div>
                    </div>
                    {% if device.records_synced > 0 %}
                    <div class="row mt-2">
                        <div class="col">
                            <small class="text-muted">Last Sync</small>
                            <div>{{ device.records_synced }} records</div>
                        </div>
                    </div>
                    {% endif %}
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-primary sync-device-btn" 
                                data-device="{{ device.name }}" 
                                {{ 'disabled' if device.status in ['connecting', 'reading', 'syncing'] else '' }}>
                            <i class="fas fa-sync-alt"></i> Sync
                        </button>
                        <button class="btn btn-sm btn-outline-info test-device-btn" 
                                data-device="{{ device.name }}">
                            <i class="fas fa-plug"></i> Test
                        </button>
                        {% if device.status in ['connecting', 'reading', 'syncing'] %}
                        <button class="btn btn-sm btn-outline-danger cancel-device-btn" 
                                data-device="{{ device.name }}">
                            <i class="fas fa-stop"></i> Cancel
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Sync Summary -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Database Summary</h5>
                    <a href="{{ url_for('sync.sync_history') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-history"></i> View History
                    </a>
                </div>
                <div class="card-body">
                    {% if sync_summary %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Device</th>
                                    <th>Total Records</th>
                                    <th>First Record</th>
                                    <th>Last Sync</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for summary in sync_summary %}
                                <tr>
                                    <td><span class="badge bg-primary">{{ summary.Machine }}</span></td>
                                    <td>{{ "{:,}".format(summary.total_records) }}</td>
                                    <td>{{ summary.first_record.strftime('%Y-%m-%d %H:%M:%S') if summary.first_record else 'N/A' }}</td>
                                    <td>{{ summary.last_sync.strftime('%Y-%m-%d %H:%M:%S') if summary.last_sync else 'N/A' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-database fa-3x mb-3"></i>
                        <p>No sync data available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Live Notifications Panel -->
<div class="row mt-4" id="notificationsPanel" style="display: none;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-bell"></i> Live Notifications 
                    <span class="badge bg-primary" id="notificationCount">0</span>
                </h6>
                <div>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearNotifications()">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshNotifications()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="notificationsList">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-bell-slash fa-2x mb-2"></i>
                        <div>No notifications yet</div>
                        <small>Notifications will appear here when streaming is active</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sync All Modal -->
<div class="modal fade" id="syncAllModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sync All Devices</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="syncAllForm">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="startDate" class="form-label">Start Date (Optional)</label>
                            <input type="date" class="form-control" id="startDate" name="start_date">
                        </div>
                        <div class="col-md-6">
                            <label for="endDate" class="form-label">End Date (Optional)</label>
                            <input type="date" class="form-control" id="endDate" name="end_date">
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            Leave dates empty to sync all available data
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="startSyncAll()">
                    <i class="fas fa-sync-alt"></i> Start Sync
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.device-card {
    transition: all 0.3s ease;
}

.device-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.status-badge.badge-idle { background-color: #6c757d; }
.status-badge.badge-connecting { background-color: #ffc107; }
.status-badge.badge-reading { background-color: #17a2b8; }
.status-badge.badge-syncing { background-color: #007bff; }
.status-badge.badge-completed { background-color: #28a745; }
.status-badge.badge-error { background-color: #dc3545; }
.status-badge.badge-cancelled { background-color: #6c757d; }

.status-message {
    font-size: 0.9em;
    max-height: 3em;
    overflow: hidden;
    text-overflow: ellipsis;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}
</style>

<script>
let statusInterval;

document.addEventListener('DOMContentLoaded', function() {
    // Start status monitoring
    startStatusMonitoring();
    
    // Initialize streaming status
    updateStreamingStatus();
    
    // Bind event handlers
    bindEventHandlers();
});

function bindEventHandlers() {
    // Sync individual device
    document.querySelectorAll('.sync-device-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const deviceName = this.dataset.device;
            syncDevice(deviceName);
        });
    });
    
    // Test device connection
    document.querySelectorAll('.test-device-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const deviceName = this.dataset.device;
            testDevice(deviceName);
        });
    });
    
    // Cancel device sync
    document.querySelectorAll('.cancel-device-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const deviceName = this.dataset.device;
            cancelSync(deviceName);
        });
    });
}

function startStatusMonitoring() {
    statusInterval = setInterval(refreshStatus, 2000); // Update every 2 seconds
}

function stopStatusMonitoring() {
    if (statusInterval) {
        clearInterval(statusInterval);
    }
}

function refreshStatus() {
    fetch('/sync/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateDeviceStatus(data.devices);
            }
        })
        .catch(error => console.error('Error refreshing status:', error));
    
    // Also check streaming status
    updateStreamingStatus();
}

// Streaming control functions
function toggleStreaming() {
    const btn = document.getElementById('streamingBtn');
    const icon = btn.querySelector('i');
    const text = document.getElementById('streamingBtnText');
    
    if (btn.classList.contains('btn-success')) {
        // Start streaming
        startStreaming();
    } else {
        // Stop streaming
        stopStreaming();
    }
}

function startStreaming() {
    const btn = document.getElementById('streamingBtn');
    const icon = btn.querySelector('i');
    const text = document.getElementById('streamingBtnText');
    
    btn.disabled = true;
    text.textContent = 'Starting...';
    
    fetch('/sync/streaming/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            btn.className = 'btn btn-danger me-2';
            icon.className = 'fas fa-stop';
            text.textContent = 'Stop Streaming';
            showToast('Streaming started successfully', 'success');
            updateStreamingUI(true, data.message);
            startNotificationMonitoring(); // Start notification monitoring
        } else {
            showToast('Failed to start streaming: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error starting streaming:', error);
        showToast('Error starting streaming', 'error');

    })
    .finally(() => {
        btn.disabled = false;
    });
}

function stopStreaming() {
    const btn = document.getElementById('streamingBtn');
    const icon = btn.querySelector('i');
    const text = document.getElementById('streamingBtnText');
    
    btn.disabled = true;
    text.textContent = 'Stopping...';
    
    fetch('/sync/streaming/stop', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            btn.className = 'btn btn-success me-2';
            icon.className = 'fas fa-play';
            text.textContent = 'Start Streaming';
            showToast('Streaming stopped successfully', 'success');
            updateStreamingUI(false, data.message);
            stopNotificationMonitoring(); // Stop notification monitoring
        } else {
            showToast('Failed to stop streaming: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error stopping streaming:', error);
        showToast('Error stopping streaming', 'error');

    })
    .finally(() => {
        btn.disabled = false;
    });
}

function updateStreamingStatus() {
    fetch('/sync/streaming/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateStreamingUI(data.streaming.running, data.streaming);
            }
        })
        .catch(error => console.error('Error getting streaming status:', error));
}

function updateStreamingUI(isRunning, streamingData) {
    const btn = document.getElementById('streamingBtn');
    const icon = btn.querySelector('i');
    const text = document.getElementById('streamingBtnText');
    const statusAlert = document.getElementById('streamingStatus');
    const statusText = document.getElementById('streamingStatusText');
    const details = document.getElementById('streamingDetails');
    
    if (isRunning) {
        btn.className = 'btn btn-danger me-2';
        icon.className = 'fas fa-stop';
        text.textContent = 'Stop Streaming';
        statusAlert.style.display = 'block';
        statusAlert.className = 'alert alert-success';
        statusText.textContent = 'Active';
        details.textContent = `Streaming from ${streamingData.devices_count || 0} devices. Active threads: ${streamingData.active_threads || 0}`;
    } else {
        btn.className = 'btn btn-success me-2';
        icon.className = 'fas fa-play';
        text.textContent = 'Start Streaming';
        statusAlert.style.display = 'block';
        statusAlert.className = 'alert alert-info';
        statusText.textContent = 'Stopped';
        details.textContent = 'Click "Start Streaming" to begin real-time data capture from devices.';
    }
}

function updateDeviceStatus(devices) {
    devices.forEach(device => {
        const card = document.querySelector(`[data-device="${device.name}"]`);
        if (card) {
            // Update status badge
            const badge = card.querySelector('.status-badge');
            badge.className = `badge status-badge badge-${device.status}`;
            badge.textContent = device.status.charAt(0).toUpperCase() + device.status.slice(1);
            
            // Update status message
            const message = card.querySelector('.status-message');
            message.textContent = device.message;
            
            // Update sync button state
            const syncBtn = card.querySelector('.sync-device-btn');
            const cancelBtn = card.querySelector('.cancel-device-btn');
            
            if (device.status === 'connecting' || device.status === 'reading' || device.status === 'syncing') {
                syncBtn.disabled = true;
                if (cancelBtn) cancelBtn.style.display = 'inline-block';
            } else {
                syncBtn.disabled = false;
                if (cancelBtn) cancelBtn.style.display = 'none';
            }
        }
    });
}

function startSyncAll() {
    const form = document.getElementById('syncAllForm');
    const formData = new FormData(form);
    
    const data = {
        start_date: formData.get('start_date') || null,
        end_date: formData.get('end_date') || null
    };
    
    fetch('/sync/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Sync started for all devices', 'success');
            bootstrap.Modal.getInstance(document.getElementById('syncAllModal')).hide();
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        showToast('Error starting sync', 'error');

        console.error('Error:', error);
    });
}

function syncDevice(deviceName) {
    fetch(`/sync/device/${deviceName}/start`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Sync started for device ${deviceName}`, 'success');
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        showToast('Error starting sync', 'error');
        console.error('Error:', error);
    });
}

function testDevice(deviceName) {
    const btn = document.querySelector(`[data-device="${deviceName}"] .test-device-btn`);
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    
    fetch(`/sync/device/${deviceName}/test`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Device ${deviceName}: ${data.message}`, 'success');
            if (data.device_info) {
                console.log('Device info:', data.device_info);
            }
        } else {
            showToast(`Device ${deviceName}: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        showToast('Error testing device', 'error');
        alert(`❌ ERROR: Error testing device ${deviceName}`);
        console.error('Error:', error);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-plug"></i> Test';
    });
}

function cancelSync(deviceName) {
    fetch('/sync/cancel', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ device_name: deviceName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        showToast('Error cancelling sync', 'error');
        console.error('Error:', error);
    });
}

function showToast(message, type = 'info') {
    // Use toastr.js for better toast notifications
    switch(type) {
        case 'success':
            toastr.success(message);
            break;
        case 'error':
            toastr.error(message);
            break;
        case 'warning':
            toastr.warning(message);
            break;
        case 'info':
        default:
            toastr.info(message);
            break;
    }
}

// Notification functions
let notificationInterval = null;
let lastNotificationCount = 0;

function startNotificationMonitoring() {
    if (notificationInterval) {
        clearInterval(notificationInterval);
    }
    
    // Show notifications panel when streaming starts
    document.getElementById('notificationsPanel').style.display = 'block';
    
    // Start polling for notifications every 3 seconds
    notificationInterval = setInterval(refreshNotifications, 3000);
    
    // Initial load
    refreshNotifications();
}

function stopNotificationMonitoring() {
    if (notificationInterval) {
        clearInterval(notificationInterval);
        notificationInterval = null;
    }
    
    // Hide notifications panel when streaming stops
    document.getElementById('notificationsPanel').style.display = 'none';
}

function refreshNotifications() {
    fetch('/sync/streaming/notifications')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateNotificationsList(data.notifications);
                updateNotificationCount(data.count);
                
                // Show badge animation if new notifications
                if (data.count > lastNotificationCount) {
                    animateNotificationBadge();
                }
                lastNotificationCount = data.count;
            }
        })
        .catch(error => console.error('Error fetching notifications:', error));
}

function updateNotificationsList(notifications) {
    const list = document.getElementById('notificationsList');
    
    if (notifications.length === 0) {
        list.innerHTML = `
            <div class="list-group-item text-center text-muted">
                <i class="fas fa-info-circle"></i> No notifications yet
            </div>
        `;
        return;
    }
    
    list.innerHTML = notifications.map(notification => `
        <div class="list-group-item list-group-item-action ${!notification.read ? 'notification-new' : ''}">
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">
                    <i class="fas fa-${getNotificationIcon(notification.type)}"></i>
                    ${notification.message}
                </h6>
                <small class="text-muted">${formatTimestamp(notification.timestamp)}</small>
            </div>
            <p class="mb-1 text-muted">
                <small>
                    <i class="fas fa-desktop"></i> ${notification.device_name}
                    ${notification.user_id ? `| <i class="fas fa-user"></i> User ${notification.user_id}` : ''}
                    ${notification.status ? `| <i class="fas fa-tag"></i> ${notification.status}` : ''}
                    ${notification.punch_code !== undefined ? `| <i class="fas fa-code"></i> Punch: ${notification.punch_code}` : ''}
                </small>
            </p>
            ${!notification.read ? '<span class="badge bg-primary">New</span>' : ''}
        </div>
    `).join('');
}

function updateNotificationCount(count) {
    const badge = document.getElementById('notificationCount');
    badge.textContent = count;
    badge.className = count > 0 ? 'badge bg-primary ms-2' : 'badge bg-secondary ms-2';
}

function getNotificationIcon(type) {
    switch(type) {
        case 'attendance': return 'clock text-success';
        case 'error': return 'exclamation-triangle text-danger';
        case 'device_connected': return 'link text-success';
        case 'device_disconnected': return 'unlink text-warning';
        case 'info': return 'info-circle text-info';
        default: return 'bell text-primary';
    }
}

function formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) { // Less than 1 minute
        return 'Just now';
    } else if (diff < 3600000) { // Less than 1 hour
        return `${Math.floor(diff / 60000)}m ago`;
    } else if (diff < 86400000) { // Less than 1 day
        return `${Math.floor(diff / 3600000)}h ago`;
    } else {
        return date.toLocaleDateString();
    }
}

function animateNotificationBadge() {
    const badge = document.getElementById('notificationCount');
    badge.style.animation = 'pulse 1s ease-in-out 3';
    setTimeout(() => {
        badge.style.animation = '';
    }, 3000);
}

function clearNotifications() {
    if (confirm('Are you sure you want to clear all notifications?')) {
        fetch('/sync/streaming/notifications/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                refreshNotifications();
                showToast('Notifications cleared', 'success');
            } else {
                showToast('Error clearing notifications', 'error');
            }
        })
        .catch(error => {
            showToast('Error clearing notifications', 'error');
            console.error('Error:', error);
        });
    }
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    stopStatusMonitoring();
    stopNotificationMonitoring();
});
</script>

<style>
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.notification-new {
    animation: slideInRight 0.5s ease-out;
}

@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

#notificationsList .list-group-item:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}
