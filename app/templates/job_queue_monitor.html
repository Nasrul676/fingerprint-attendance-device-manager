{% extends "base.html" %}

{% block title %}Job Queue Monitor - Attendance System{% endblock %}

{% block extra_css %}
<style>
    .monitor-header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 2rem 0;
        margin: -2rem -15px 2rem -15px;
        border-radius: 0 0 15px 15px;
    }
    
    .queue-controls {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
    }
    
    .queue-table {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }
    
    .status-filter {
        margin-bottom: 1rem;
    }
    
    .status-filter .btn {
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .job-row {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .job-row:hover {
        background-color: #f8f9fa;
        transform: scale(1.01);
    }
    
    .priority-indicator {
        width: 8px;
        height: 40px;
        border-radius: 4px;
        margin-right: 1rem;
    }
    
    .priority-1, .priority-2 { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); }
    .priority-3, .priority-4 { background: linear-gradient(135deg, #ffa726 0%, #ffcc02 100%); }
    .priority-5, .priority-6 { background: linear-gradient(135deg, #42a5f5 0%, #478ed1 100%); }
    .priority-7, .priority-8 { background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%); }
    .priority-9, .priority-10 { background: linear-gradient(135deg, #bdbdbd 0%, #9e9e9e 100%); }
    
    .job-status-badge {
        font-weight: bold;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.875em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
    }
    
    .status-pending { 
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        color: #856404; 
    }
    .status-running { 
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        color: #0c5460; 
    }
    .status-completed { 
        background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
        color: #155724; 
    }
    .status-failed { 
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        color: #721c24; 
    }
    .status-cancelled { 
        background: linear-gradient(135deg, #e2e2e2 0%, #c9c9c9 100%);
        color: #6c757d; 
    }
    
    .running-pulse {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    
    .queue-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .stat-item {
        text-align: center;
        padding: 1rem;
        border-radius: 8px;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
    }
    
    .stat-number {
        font-size: 1.5rem;
        font-weight: bold;
        color: #495057;
    }
    
    .stat-label {
        font-size: 0.875rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .real-time-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        z-index: 1050;
    }
    
    .real-time-indicator.connecting {
        background: #ffc107;
        color: #212529;
    }
    
    .real-time-indicator.disconnected {
        background: #dc3545;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-action {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        border-radius: 4px;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    @media (max-width: 768px) {
        .queue-stats {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .real-time-indicator {
            position: relative;
            top: auto;
            right: auto;
            margin-bottom: 1rem;
            text-align: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Monitor Header -->
<div class="monitor-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="fas fa-list-ul me-3"></i>Job Queue Monitor
                </h1>
                <p class="mb-0 opacity-75">Real-time monitoring of job queue and processing status</p>
            </div>
            <div class="col-md-4 text-md-end">
                <button class="btn btn-light" id="refreshQueue">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-light ms-2" id="toggleAutoRefresh">
                    <i class="fas fa-pause"></i> Auto Refresh
                </button>
                <div class="dropdown d-inline-block ms-2">
                    <button class="btn btn-success dropdown-toggle" type="button" id="workerControlDropdown" data-bs-toggle="dropdown">
                        <i class="fas fa-cogs"></i> Worker Control
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" id="startWorkerBtn">
                            <i class="fas fa-play text-success"></i> Start Job Worker
                        </a></li>
                        <li><a class="dropdown-item" href="#" id="stopWorkerBtn">
                            <i class="fas fa-stop text-danger"></i> Stop Job Worker
                        </a></li>
                        <li><a class="dropdown-item" href="#" id="restartWorkerBtn">
                            <i class="fas fa-redo text-warning"></i> Restart Job Worker
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="workerStatusBtn">
                            <i class="fas fa-info-circle text-info"></i> Check Worker Status
                        </a></li>
                        <li><a class="dropdown-item" href="#" id="createTestJobBtn">
                            <i class="fas fa-plus text-primary"></i> Create Test Job
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Status Indicator -->
<div class="real-time-indicator" id="realTimeStatus">
    <i class="fas fa-circle me-1"></i>
    <span>Live Monitoring</span>
</div>

<!-- Worker Status Indicator -->
<div class="fixed-top mt-5 me-3" style="top: 70px; right: 20px; z-index: 1049;">
    <div class="alert alert-info alert-dismissible" id="workerStatusAlert" style="display: none;">
        <i class="fas fa-info-circle me-1"></i>
        <span id="workerStatusText">Checking worker status...</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
</div>

<div class="container-fluid">
    <!-- Queue Statistics -->
    <div class="queue-controls">
        <h5 class="mb-3">
            <i class="fas fa-chart-bar me-2"></i>Queue Statistics
        </h5>
        <div class="queue-stats" id="queueStats">
            <div class="stat-item">
                <div class="stat-number" id="totalJobs">-</div>
                <div class="stat-label">Total Jobs</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="pendingJobs">-</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="runningJobs">-</div>
                <div class="stat-label">Running</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="completedJobs">-</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="failedJobs">-</div>
                <div class="stat-label">Failed</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="avgProcessTime">-</div>
                <div class="stat-label">Avg. Time</div>
            </div>
        </div>
    </div>

    <!-- Queue Controls -->
    <div class="queue-controls">
        <h5 class="mb-3">
            <i class="fas fa-filter me-2"></i>Queue Filters
        </h5>
        
        <!-- Status Filter -->
        <div class="status-filter">
            <label class="form-label">Filter by Status:</label><br>
            <button class="btn btn-outline-primary btn-sm active" data-status="all">All</button>
            <button class="btn btn-outline-warning btn-sm" data-status="pending">Pending</button>
            <button class="btn btn-outline-info btn-sm" data-status="running">Running</button>
            <button class="btn btn-outline-success btn-sm" data-status="completed">Completed</button>
            <button class="btn btn-outline-danger btn-sm" data-status="failed">Failed</button>
            <button class="btn btn-outline-secondary btn-sm" data-status="cancelled">Cancelled</button>
        </div>
        
        <!-- Additional Filters -->
        <div class="row">
            <div class="col-md-3">
                <label for="priorityFilter" class="form-label">Priority:</label>
                <select class="form-control form-control-sm" id="priorityFilter">
                    <option value="">All Priorities</option>
                    <option value="1,2">Critical (1-2)</option>
                    <option value="3,4">High (3-4)</option>
                    <option value="5,6">Normal (5-6)</option>
                    <option value="7,8">Low (7-8)</option>
                    <option value="9,10">Very Low (9-10)</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="jobTypeFilter" class="form-label">Job Type:</label>
                <select class="form-control form-control-sm" id="jobTypeFilter">
                    <option value="">All Types</option>
                    <option value="procedure_processing">Procedure Processing</option>
                    <option value="data_sync">Data Sync</option>
                    <option value="cleanup">Cleanup</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="dateFilter" class="form-label">Date Range:</label>
                <select class="form-control form-control-sm" id="dateFilter">
                    <option value="">All Time</option>
                    <option value="today">Today</option>
                    <option value="yesterday">Yesterday</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="limitFilter" class="form-label">Show:</label>
                <select class="form-control form-control-sm" id="limitFilter">
                    <option value="50">50 jobs</option>
                    <option value="100">100 jobs</option>
                    <option value="200">200 jobs</option>
                    <option value="500">500 jobs</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Queue Table -->
    <div class="queue-table">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="fas fa-table me-2"></i>Job Queue
                <span class="badge bg-primary ms-2" id="jobCount">0</span>
            </h5>
            <div>
                <button class="btn btn-outline-secondary btn-sm" id="selectAll">
                    <i class="fas fa-check-square"></i> Select All
                </button>
                <button class="btn btn-outline-danger btn-sm" id="bulkCancel" disabled>
                    <i class="fas fa-ban"></i> Cancel Selected
                </button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover" id="queueTable">
                <thead class="table-light">
                    <tr>
                        <th width="40">
                            <input type="checkbox" class="form-check-input" id="selectAllCheckbox">
                        </th>
                        <th width="10"></th> <!-- Priority indicator -->
                        <th>Job Info</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Progress</th>
                        <th>Timing</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="queueTableBody">
                    <!-- Loading placeholder -->
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading job queue...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="Queue pagination" id="queuePagination" style="display: none;">
            <ul class="pagination justify-content-center">
                <!-- Pagination will be generated dynamically -->
            </ul>
        </nav>
    </div>
</div>

<!-- Job Details Modal -->
<div class="modal fade" id="jobDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>Job Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="jobDetailsContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Close
                </button>
                <button type="button" class="btn btn-danger" id="cancelJobBtn" style="display: none;">
                    <i class="fas fa-ban me-1"></i>Cancel Job
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/job-queue-monitor.js"></script>
{% endblock %}